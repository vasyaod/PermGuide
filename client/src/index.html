<html>
	<head>
		<title>PhoneGap</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<link rel="stylesheet" type="text/css" href="style.css" />

		<script type="text/javascript" charset="utf-8" src="phonegap.js"></script>

		<script type="text/javascript" src="jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="browserTouchSupport.js"></script>
		<script type="text/javascript" src="jsrender.js"></script>

		<!-- Загрузка основного кода. -->
		<script type="text/javascript" src="permguide-lr.js"></script>
		<script type="text/javascript" src="permguide-scheduler.js"></script>
		<script type="text/javascript" src="permguide-touch-support.js"></script>
		<script type="text/javascript" src="permguide-toggle-button.js"></script>
		<script type="text/javascript" src="permguide-observable.js"></script>
		<script type="text/javascript" src="permguide-scrollable-plugin.js"></script>
		<script type="text/javascript" src="permguide.js"></script>

		<script type="text/javascript">

		interfaceInit = function() {
			
			// Зададим мертвый радиус для клика в процентах экрана.
			//PermGuide.deadRadius = $(window).width()*0.04;
			PermGuide.deadRadius = 20;
				
			////
			// Это такой хитрый способ, выстроить дивы в линейку.
			var slideToLine = function() {
//				$(".slide").css("width", "100%");
//				$("#slideContainer").css("width", "100%");
				$("#slideContainer").css("width", $("#pageSlider").width()*$(".slide").length);
				$(".slide").css("width", $("#pageSlider").width());
			};
			slideToLine();
			$(window).resize(function() {
				// Пересчитаем нашу линейку сладов.
				slideToLine();
				PermGuide.PageSlider.refresh();
			});
			
			////
			// Вешаем событие на кнопку "Нажми, что бы закрыть"
			$("#closeButton").touchclick( function () {
				//$("#objectInfo").css("visibility", "hidden");
				//$("#pageSlider").css("visibility", "visible");
				PermGuide.ObjectInfoWindow.toggle();
			});
			
			////
			// Инициализируем выпадаущее окно со списком меток.
			PermGuide.DropDownWindow.init($("#tagsMenu"));

			////
			// Инициализируем окна информации.
			PermGuide.ObjectInfoWindow.init($("#objectInfo"));

			////
			// Инициализируем слайдер страниц.
			PermGuide.PageSlider.init($("#slideContainer"));
			
			// Устанавливает обработчик переключения страниц.
			PermGuide.PageSlider.listener = function(index) {
				$(".pageIndicator").css("background-color","#eeeeee");
				$(".pageIndicator").slice(index, index+1).css("background-color","#666666");
			};
			PermGuide.PageSlider.listener(0); // Подсветим сразуже первую страницу.
			
			$(".pageIndicator").touchclick( function(event) {
				PermGuide.PageSlider.select(parseInt($(event.target).text())-1);
			});
			
			$("#nextButton").touchclick( function(event) {
				PermGuide.PageSlider.next();
			});
			
			$("#prevButton").touchclick( function(event) {
				PermGuide.PageSlider.prev();
			});
			
			// Вешаем на скроллер события тача.
			$("#pageScroller").touchstart( function(event) {
				PermGuide.PageSlider.down(event);
			});
			
			$("#pageScroller").touchmove( function(event) {
				PermGuide.PageSlider.move(event);
			});

			$("#pageScroller").touchend( function(event) {
				PermGuide.PageSlider.up(event);
			});
			////

			////
			// Инициализация скроленга страниц.
			$(".vScroller").scrollable();
			
			// Загружаем данные об объектах (достопримечательности, линии и т.д.).
			PermGuide.ApplicationData.load();
			
			// При загрузке данных формируем содержимое выподающего окна
			// со списком меток.
			PermGuide.ApplicationData.attachListener("loaded", function (applicationData){
			
				$("#tagsBg .vScroller").html(
					$( "#tagTemplate" ).render(applicationData.data.tags)
				);
				
				$(".tag").touchclick( function (event) {
					var tagId = $(event.target).attr("_id");
					var tag = applicationData.getTagById(tagId);
					if (tag == null)
						return;
					if (tag.visible)
						$(event.target).removeClass("visibledTag");
					else
						$(event.target).addClass("visibledTag");
					tag.setVisible(!tag.visible);
				});
			
			});
			// При включении/отключении тэгов, формируем 
			PermGuide.ApplicationData.attachListener("visibleChanged", function (applicationData){
				
				$("#objectsCatalog").html(
					$( "#catalogItemTemplate" ).render(applicationData.getVisibleObjects())
				);
				
				$(".catalogItem").touchclick( function (event) {
					var objectId = $(event.target).attr("_id");
					var object = applicationData.getObjectById(objectId);
					PermGuide.ApplicationData.selectObject(object);
				});
			});
			
			PermGuide.ApplicationData.attachListener("objectSelected", function(object) {
				
				// Сбросим позицию дива.
				$("#objectInfo .vScroller").data().resetPosition();
				// Сгенерируем из шаблона новую информацию об объекте.
				$("#objectInfo .vScroller").html(
					$( "#objectInfoTemplate" ).render([object])
				);
				PermGuide.ObjectInfoWindow.toggle();
			});
			
			////
			// Переключение между картой и списком объектов.
			$("#switchObjectMode").toggleButton({
				on: function() {
					$("#objectsCatalog").css("display", "none");
					$("#objectsMap").css("display", "block");
				},
				off: function() {
					$("#objectsMap").css("display", "none");
					$("#objectsCatalog").css("display", "block");
				},
				state: true
			});
			
			////
			// Инициализация карты.
			$.getScript('http://api-maps.yandex.ru/1.1/index.xml?loadByRequire=1&key=AAC5U08BAAAAhG98TwIAUF_dcR_gLZsbQ6zwFcalQlEjkMsAAAAAAAAAAADLl1k_yHuuKf8xCzG-8rc6q0B5jA==', function() {
				//alert("Script of map load succesful!");
				PermGuide.MapManager.init(jQuery("#objectsMap")[0]);
			}).fail(function(){
				alert("Load script of map fail!");
				// Завершим задасу запуска интерфейса.
				PermGuide.Scheduler.finished("InterfaceInit");
			});
//*/
		};
		
		languageSelectInit = function() {
			if (PermGuide.Language.languageSelected)
			{
				PermGuide.Scheduler.finished("LanguageSelect");
				return;
			}
			// Повешаем на кнопки выбора языка обработчики.
			$(".langSelectItem").touchclick( function(event) {
				var lang = $(event.target).attr("_lang");
				PermGuide.Language.currentLanguage = lang;
				
				$("#langSelectScreen").css("visibility", "hidden");
				$("#splashScreen").css("visibility", "visible");
				
				// Завершим выполнение задания.
				PermGuide.Scheduler.finished("LanguageSelect");
			});
			
			$("#splashScreen").css("visibility", "hidden");
			$("#langSelectScreen").css("visibility", "visible");
		};

		closeSplash = function() {
			// Перед тем как скрыть splash интернацианализируем интерфейс.
			$(".i18n").each(function(index){
				var text = PermGuide.Language.getInterfaceString($(this).text());
				$(this).text(text);
			});
		
			// Закроем splash-screen
			$("#splashScreen").css("visibility", "hidden");
			$("#pageSlider").css("visibility", "visible");
		}
		
		$(document).ready(function() {
			
			PermGuide.Scheduler.addTask("LanguageSelect",{
				activateFn: languageSelectInit,
				dependence: []
			});
			PermGuide.Scheduler.addTask("InterfaceInit",{
				activateFn: interfaceInit,
				dependence: ["LanguageSelect"]
			});
			PermGuide.Scheduler.addTask("CloseSplash",{
				activateFn: closeSplash,
				dependence: ["InterfaceInit"]
			});

			PermGuide.Scheduler.start();
		});

		</script>
		
		<!-- 
			Шаблон тэгов в выподающем окне.
		-->
		<script id="tagTemplate" type="text/x-jsrender">
			<div class="tag{{if visible}} visibledTag{{/if}}" _id="{{:id}}">{{:name}}</div>
		</script>

		<!-- 
			Шаблон пункта в каталоге.
		-->
		<script id="catalogItemTemplate" type="text/x-jsrender">
			<div class="catalogItem" _id="{{:id}}">{{:name}}</div>
		</script>

		<!-- 
			Шаблон информации об объекте.
		-->
		<script id="objectInfoTemplate" type="text/x-jsrender">
			<div>{{:name}}</div>
			<div>{{:description}}</div>
		</script>
	</head>
	<body>
		<div id="body">
		
			<div id="splashScreen" style="">
				<div style="margin-top: 30%">Идет загрузка приложения (карты, данных и другой фигни).</div> 
			</div>
	
			<div id="langSelectScreen">
				<div class="langSelectItem" _lang="ru">Русский</div>
				<div class="langSelectItem" _lang="en">English</div>
			</div>
			
			<div id="pageSlider">
				<div id="slideContainer">
					<!-- 
						Для для программы сладера страниц, ваден только элемент с
						классом "slide", который и является страницей.
					 -->
					<div class="slide">
						<div style="height: 100%;">
							<div class="i18n" style="padding-top: 30%">Intro</div>
						</div> 
					</div>
					
					<div class="slide">
						<div id="tagsMenu" class="dropDownMenu">
							<!--
								В выподающем окне, для скрипта важен только элемент 
								с классом "toggleButton", все остальные id и классы, нужны
								чтобы накладывать стиль.
							-->
							<div id="tagsBg">
								<div class="vScroller"> 
									<!-- Пусто, значения подствляются скриптом.-->
								</div>
							</div>
							<div class="toggleButton">
								<table border="0" cellpadding="0" cellspacing="0" style="width: 100%; height: 100%">
									<tr>
										<td class="i18n" style="text-align: center;">ТoggleButton</td>
										<td id="switchObjectMode" style="width: 15%; background-color: #000000; color: #eeeeee">
											<div class="on">списком</div>
											<div class="off">на карте</div>
										</td>
									</tr>
								</table>
							</div>
						</div>
						<div class="dropDownMenuSeparator">
							<!-- Просто что бы отодвинуть содержимое вниз. -->
						</div>				
						<canvas id="myCanvas" class="canvasLayer">
							Браузер не поддерживает Canvas.
						</canvas>
					
						<div id="objectsMap"></div>
						<div id="objectsCatalog">
							<div class="vScroller"> 
								Каталог пуст.
							</div>
						</div>					
					</div>
					<div class="slide">
						Пусто, блин!!! Пока.
					</div>
				</div>
				<div id="pageScroller">
					<table border="0" cellpadding="0" cellspacing="0">
						<tr>
							<td>
								<div id="prevButton" class="i18n">PrevButton</div>
							</td>
							<!-- 
								Внимание! От содержимого ячеек зависит их кликабильность
							 	смотрите код!
							-->
							<td><div class="pageIndicator">1</div></td>
							<td><div class="pageIndicator">2</div></td>
							<td><div class="pageIndicator">3</div></td>
							<td style="text-align: right;">
								<div id="nextButton" class="i18n">NextButton</div>
							</td>
						</tr>
					</table>
				</div>			
			</div>
	
			<div id="objectInfo"> 
				<div style="height: 90%; overflow: hidden;">
					<div class="vScroller"> 
						Информации нет!
					</div>
				</div>
				<div style="height: 10%;"> 
					<div id="closeButton" style="margin-top: 2%; text-align: center;">Нажми, что бы закрыть</div> 
				</div>
			</div>
		</div>
	</body>
</html>